name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Run tests
      run: mvn test

    - name: Publish artifacts to Nexus
      run: mvn deploy -DskipTests
      env:
        NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
        NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

    - name: Build Docker image
      run: |
        docker build -t nexus-web-app:${{ github.sha }} .
        docker tag nexus-web-app:${{ github.sha }} nexus-web-app:latest

    - name: Login to Nexus Docker Registry
      run: echo "${{ secrets.NEXUS_PASSWORD }}" | docker login localhost:8082 -u "${{ secrets.NEXUS_USERNAME }}" --password-stdin

    - name: Push Docker image to Nexus
      run: |
        docker tag nexus-web-app:latest localhost:8082/nexus-web-app:${{ github.sha }}
        docker tag nexus-web-app:latest localhost:8082/nexus-web-app:latest
        docker push localhost:8082/nexus-web-app:${{ github.sha }}
        docker push localhost:8082/nexus-web-app:latest
